<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>完全导入功能测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .test-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .test-item {
            padding: 10px;
            border: 1px solid #eee;
            border-radius: 5px;
            background: #f9f9f9;
        }
        .test-item h4 {
            margin: 0 0 10px 0;
            color: #333;
        }
        .test-item.success {
            border-color: #28a745;
            background: #d4edda;
        }
        .test-item.warning {
            border-color: #ffc107;
            background: #fff3cd;
        }
        .test-item.error {
            border-color: #dc3545;
            background: #f8d7da;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .result {
            margin-top: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 12px;
        }
        .status {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 3px;
            font-size: 12px;
            font-weight: bold;
        }
        .status.success { background: #28a745; color: white; }
        .status.warning { background: #ffc107; color: black; }
        .status.error { background: #dc3545; color: white; }
    </style>
</head>
<body>
    <h1>完全导入功能测试</h1>
    
    <div class="test-section">
        <h3>测试数据解析</h3>
        <button onclick="testParseCompleteData()">测试完整数据解析</button>
        <div id="parseResult" class="result"></div>
    </div>
    
    <div class="test-section">
        <h3>导入功能测试</h3>
        <button onclick="testFileImport()">选择文件测试完全导入</button>
        <div id="importResult" class="result"></div>
    </div>
    
    <div class="test-section">
        <h3>数据完整性检查</h3>
        <div class="test-grid" id="dataCheckGrid">
            <!-- 测试项目将在这里生成 -->
        </div>
    </div>

    <script>
        // 模拟解析函数
        function parseAndImportMarkdown(markdownContent) {
            try {
                const lines = markdownContent.split('\n');
                let currentSection = '';
                let tasks = [];
                let pomodoroData = [];
                let completedTasks = [];
                let incompleteTasks = [];
                let dailyGains = '';
                let improvements = '';
                let startTime = '';
                let currentDate = '';
                
                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i].trim();
                    
                    // 解析日期
                    if (line.startsWith('## 日期：')) {
                        currentDate = line.replace('## 日期：', '').trim();
                        continue;
                    }
                    
                    // 检测章节
                    if (line.startsWith('### 今日目标任务')) {
                        currentSection = 'tasks';
                        continue;
                    } else if (line.startsWith('### 番茄时段记录')) {
                        currentSection = 'pomodoro';
                        continue;
                    } else if (line.startsWith('**完成的任务：**')) {
                        currentSection = 'completed';
                        continue;
                    } else if (line.startsWith('**未完成的任务：**')) {
                        currentSection = 'incomplete';
                        continue;
                    } else if (line.startsWith('**今日收获：**')) {
                        currentSection = 'gains';
                        continue;
                    } else if (line.startsWith('**明日改进点：**')) {
                        currentSection = 'improvements';
                        continue;
                    }
                    
                    // 解析任务
                    if (currentSection === 'tasks' && line.startsWith('- [')) {
                        const taskMatch = line.match(/- \[([ x])\] 任务(\d+)：(.+)/);
                        if (taskMatch) {
                            const status = taskMatch[1];
                            const taskNum = taskMatch[2];
                            const taskText = taskMatch[3];
                            tasks.push({
                                number: parseInt(taskNum),
                                text: taskText,
                                completed: status === 'x'
                            });
                        }
                    }
                    
                    // 解析番茄时段
                    if (currentSection === 'pomodoro' && line.startsWith('|') && !line.includes('---')) {
                        const parts = line.split('|').map(p => p.trim()).filter(p => p);
                        if (parts.length >= 5) {
                            const timeRange = parts[0];
                            const taskContent = parts[1];
                            const status = parts[2];
                            const completion = parts[3];
                            const notes = parts[4];
                            
                            // 提取开始时间
                            if (!startTime && timeRange.includes('-')) {
                                const timeMatch = timeRange.match(/(\d{2}:\d{2})-/);
                                if (timeMatch) {
                                    startTime = timeMatch[1];
                                }
                            }
                            
                            pomodoroData.push({
                                timeRange: timeRange,
                                taskContent: taskContent,
                                status: status,
                                completion: completion,
                                notes: notes
                            });
                        }
                    }
                    
                    // 解析完成的任务
                    if (currentSection === 'completed' && line.startsWith('- ✅')) {
                        const taskText = line.replace('- ✅', '').trim();
                        if (taskText) {
                            completedTasks.push(taskText);
                        }
                    }
                    
                    // 解析未完成的任务
                    if (currentSection === 'incomplete' && line.startsWith('- ❌')) {
                        const taskText = line.replace('- ❌', '').trim();
                        if (taskText) {
                            incompleteTasks.push(taskText);
                        }
                    }
                    
                    // 解析今日收获
                    if (currentSection === 'gains' && line && !line.startsWith('**')) {
                        if (dailyGains) dailyGains += '\n';
                        dailyGains += line;
                    }
                    
                    // 解析明日改进点
                    if (currentSection === 'improvements' && line && !line.startsWith('**')) {
                        if (improvements) improvements += '\n';
                        improvements += line;
                    }
                }
                
                return {
                    currentDate: currentDate,
                    startTime: startTime,
                    tasks: tasks,
                    pomodoroData: pomodoroData,
                    completedTasks: completedTasks,
                    incompleteTasks: incompleteTasks,
                    dailyGains: dailyGains,
                    improvements: improvements
                };
                
            } catch (error) {
                console.error('解析失败:', error);
                throw error;
            }
        }
        
        function testParseCompleteData() {
            const testData = `# 番茄工作法追踪表

## 日期：2024年1月15日 星期一

### 今日目标任务
- [x] 任务1：完成项目需求分析文档
- [ ] 任务2：设计用户界面原型
- [x] 任务3：编写核心功能代码

### 番茄时段记录

| 时间段 | 任务内容 | 完成状态 | 完成度 | 备注/干扰记录 |
|--------|----------|----------|--------|---------------|
| 09:00-09:25 | 项目需求分析 | ✅ | 100% | 顺利完成 |
| 09:30-09:55 | 需求文档编写 | ✅ | 90% | 需要补充细节 |
| 10:00-10:25 | 界面设计构思 | ⭕ | | 被电话打断 |
| **长休息 11:00-11:30** | **🍃 休息时间** |   |        |               |
| 11:30-11:55 | 核心功能开发 | ✅ | 80% | 遇到技术问题 |

### 今日总结

**完成的任务：**
- ✅ 完成项目需求分析文档
- ✅ 编写核心功能代码

**未完成的任务：**
- ❌ 设计用户界面原型

**今日收获：**
通过番茄工作法，我发现自己能够更专注地处理复杂任务。

**明日改进点：**
1. 提前准备设计素材
2. 设置免打扰模式`;

            try {
                const result = parseAndImportMarkdown(testData);
                document.getElementById('parseResult').textContent = 
                    '解析成功！\n\n' +
                    '日期：' + result.currentDate + '\n' +
                    '开始时间：' + result.startTime + '\n\n' +
                    '任务数据：' + JSON.stringify(result.tasks, null, 2) + '\n\n' +
                    '番茄时段数据：' + JSON.stringify(result.pomodoroData, null, 2) + '\n\n' +
                    '完成的任务：' + JSON.stringify(result.completedTasks, null, 2) + '\n\n' +
                    '未完成的任务：' + JSON.stringify(result.incompleteTasks, null, 2) + '\n\n' +
                    '今日收获：' + result.dailyGains + '\n\n' +
                    '明日改进点：' + result.improvements;
            } catch (error) {
                document.getElementById('parseResult').textContent = '解析失败：' + error.message;
            }
        }
        
        function testFileImport() {
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = '.md,.txt';
            fileInput.style.display = 'none';
            
            fileInput.onchange = function(event) {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            const markdownContent = e.target.result;
                            const result = parseAndImportMarkdown(markdownContent);
                            
                            let importResult = '文件导入成功！\n\n';
                            importResult += '解析到的数据：\n';
                            importResult += '日期：' + (result.currentDate || '未找到') + '\n';
                            importResult += '开始时间：' + (result.startTime || '未找到') + '\n';
                            importResult += '任务数量：' + result.tasks.length + '\n';
                            importResult += '番茄时段数量：' + result.pomodoroData.length + '\n';
                            importResult += '完成的任务数量：' + result.completedTasks.length + '\n';
                            importResult += '未完成的任务数量：' + result.incompleteTasks.length + '\n';
                            importResult += '今日收获：' + (result.dailyGains ? '有内容' : '无内容') + '\n';
                            importResult += '明日改进点：' + (result.improvements ? '有内容' : '无内容') + '\n';
                            
                            document.getElementById('importResult').textContent = importResult;
                            
                            // 更新数据完整性检查
                            updateDataCheckGrid(result);
                            
                        } catch (error) {
                            document.getElementById('importResult').textContent = '导入失败：' + error.message;
                        }
                    };
                    reader.readAsText(file, 'utf-8');
                }
            };
            
            document.body.appendChild(fileInput);
            fileInput.click();
            document.body.removeChild(fileInput);
        }
        
        function updateDataCheckGrid(result) {
            const grid = document.getElementById('dataCheckGrid');
            grid.innerHTML = '';
            
            const checks = [
                {
                    name: '日期信息',
                    value: result.currentDate,
                    status: result.currentDate ? 'success' : 'error'
                },
                {
                    name: '开始时间',
                    value: result.startTime,
                    status: result.startTime ? 'success' : 'warning'
                },
                {
                    name: '任务数据',
                    value: result.tasks.length + ' 个任务',
                    status: result.tasks.length > 0 ? 'success' : 'warning'
                },
                {
                    name: '番茄时段',
                    value: result.pomodoroData.length + ' 个时段',
                    status: result.pomodoroData.length > 0 ? 'success' : 'warning'
                },
                {
                    name: '完成的任务',
                    value: result.completedTasks.length + ' 个',
                    status: result.completedTasks.length >= 0 ? 'success' : 'error'
                },
                {
                    name: '未完成的任务',
                    value: result.incompleteTasks.length + ' 个',
                    status: result.incompleteTasks.length >= 0 ? 'success' : 'error'
                },
                {
                    name: '今日收获',
                    value: result.dailyGains ? '有内容' : '无内容',
                    status: result.dailyGains ? 'success' : 'warning'
                },
                {
                    name: '明日改进点',
                    value: result.improvements ? '有内容' : '无内容',
                    status: result.improvements ? 'success' : 'warning'
                }
            ];
            
            checks.forEach(check => {
                const item = document.createElement('div');
                item.className = `test-item ${check.status}`;
                item.innerHTML = `
                    <h4>${check.name}</h4>
                    <div>${check.value}</div>
                    <span class="status ${check.status}">${getStatusText(check.status)}</span>
                `;
                grid.appendChild(item);
            });
        }
        
        function getStatusText(status) {
            switch(status) {
                case 'success': return '✓ 成功';
                case 'warning': return '⚠ 警告';
                case 'error': return '✗ 错误';
                default: return '? 未知';
            }
        }
        
        // 页面加载时初始化
        window.onload = function() {
            updateDataCheckGrid({});
        };
    </script>
</body>
</html> 