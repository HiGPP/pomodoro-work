<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>备份恢复功能测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .test-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .test-item {
            padding: 10px;
            border: 1px solid #eee;
            border-radius: 5px;
            background: #f9f9f9;
        }
        .test-item h4 {
            margin: 0 0 10px 0;
            color: #333;
        }
        .test-item.success {
            border-color: #28a745;
            background: #d4edda;
        }
        .test-item.warning {
            border-color: #ffc107;
            background: #fff3cd;
        }
        .test-item.error {
            border-color: #dc3545;
            background: #f8d7da;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .result {
            margin-top: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 12px;
        }
        .status {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 3px;
            font-size: 12px;
            font-weight: bold;
        }
        .status.success { background: #28a745; color: white; }
        .status.warning { background: #ffc107; color: black; }
        .status.error { background: #dc3545; color: white; }
        input, textarea {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .backup-info {
            background: #e3f2fd;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h1>备份恢复功能测试</h1>
    
    <div class="test-section">
        <h3>测试数据输入</h3>
        <div>
            <label>测试输入：</label>
            <input type="text" id="testInput" placeholder="输入一些测试数据...">
        </div>
        <div>
            <label>测试文本：</label>
            <textarea id="testTextarea" placeholder="输入多行测试数据..."></textarea>
        </div>
        <div>
            <label>测试选择：</label>
            <select id="testSelect">
                <option value="">请选择...</option>
                <option value="option1">选项1</option>
                <option value="option2">选项2</option>
                <option value="option3">选项3</option>
            </select>
        </div>
        <div>
            <label>
                <input type="checkbox" id="testCheckbox"> 测试复选框
            </label>
        </div>
        <button onclick="createBackup()">创建备份</button>
        <button onclick="restoreBackup()">恢复备份</button>
        <button onclick="clearTestData()">清除数据</button>
        <div id="testResult" class="result"></div>
    </div>
    
    <div class="test-section">
        <h3>备份功能检查</h3>
        <div class="test-grid" id="backupGrid">
            <!-- 测试项目将在这里生成 -->
        </div>
    </div>
    
    <div class="test-section">
        <h3>备份文件测试</h3>
        <button onclick="testBackupCreation()">测试备份创建</button>
        <button onclick="testBackupValidation()">测试备份验证</button>
        <button onclick="testBackupRestore()">测试备份恢复</button>
        <div id="backupResult" class="result"></div>
    </div>

    <script>
        // 模拟备份数据创建
        function createBackup() {
            try {
                const backupData = {
                    // 基本信息
                    currentDate: new Date().toLocaleDateString('zh-CN'),
                    startTime: '09:00',
                    taskCount: '5',
                    
                    // 任务数据
                    tasks: [
                        { number: 1, text: '测试任务1', completed: true },
                        { number: 2, text: '测试任务2', completed: false },
                        { number: 3, text: '测试任务3', completed: true }
                    ],
                    
                    // 番茄时段数据
                    pomodoroTable: [
                        {
                            timeRange: '09:00-09:25',
                            taskContent: '测试任务1',
                            status: 'completed',
                            completion: '100',
                            notes: '测试备注'
                        },
                        {
                            timeRange: '09:30-09:55',
                            taskContent: '测试任务2',
                            status: 'interrupted',
                            completion: '60',
                            notes: '被中断'
                        }
                    ],
                    
                    // 总结数据
                    completedTasks: '完成了测试任务1和测试任务3',
                    incompleteTasks: '测试任务2未完成',
                    dailyGains: '学会了新的测试方法',
                    improvements: '明天要更专注',
                    
                    // 统计信息
                    completedCount: '2',
                    totalCount: '3',
                    avgCompletion: '80%',
                    
                    // 备份信息
                    backupAt: new Date().toISOString(),
                    version: '1.0'
                };
                
                // 保存到本地存储
                localStorage.setItem('testBackupData', JSON.stringify(backupData));
                
                document.getElementById('testResult').textContent = '✅ 备份数据已创建！';
                updateBackupGrid();
                
            } catch (error) {
                document.getElementById('testResult').textContent = '❌ 创建备份失败：' + error.message;
            }
        }
        
        // 恢复备份数据
        function restoreBackup() {
            try {
                const savedData = localStorage.getItem('testBackupData');
                if (savedData) {
                    const backupData = JSON.parse(savedData);
                    
                    // 恢复数据到界面
                    document.getElementById('testInput').value = backupData.currentDate || '';
                    document.getElementById('testTextarea').value = backupData.completedTasks || '';
                    document.getElementById('testSelect').value = 'option1';
                    document.getElementById('testCheckbox').checked = true;
                    
                    document.getElementById('testResult').textContent = '✅ 备份数据已恢复！';
                    updateBackupGrid();
                    
                } else {
                    document.getElementById('testResult').textContent = '❌ 没有找到备份数据！';
                }
                
            } catch (error) {
                document.getElementById('testResult').textContent = '❌ 恢复备份失败：' + error.message;
            }
        }
        
        // 清除测试数据
        function clearTestData() {
            if (confirm('确定要清除所有测试数据吗？')) {
                localStorage.removeItem('testBackupData');
                document.getElementById('testInput').value = '';
                document.getElementById('testTextarea').value = '';
                document.getElementById('testSelect').value = '';
                document.getElementById('testCheckbox').checked = false;
                
                document.getElementById('testResult').textContent = '✅ 数据已清除！';
                updateBackupGrid();
            }
        }
        
        // 更新备份检查网格
        function updateBackupGrid() {
            const grid = document.getElementById('backupGrid');
            grid.innerHTML = '';
            
            const savedData = localStorage.getItem('testBackupData');
            const backupData = savedData ? JSON.parse(savedData) : null;
            
            const checks = [
                {
                    name: '备份文件格式',
                    value: backupData ? 'JSON格式' : '无备份',
                    status: backupData ? 'success' : 'warning'
                },
                {
                    name: '版本信息',
                    value: backupData && backupData.version ? backupData.version : '无版本信息',
                    status: backupData && backupData.version ? 'success' : 'error'
                },
                {
                    name: '备份时间',
                    value: backupData && backupData.backupAt ? new Date(backupData.backupAt).toLocaleString() : '无时间信息',
                    status: backupData && backupData.backupAt ? 'success' : 'error'
                },
                {
                    name: '任务数据',
                    value: backupData && backupData.tasks ? `${backupData.tasks.length}个任务` : '无任务数据',
                    status: backupData && backupData.tasks ? 'success' : 'warning'
                },
                {
                    name: '番茄时段',
                    value: backupData && backupData.pomodoroTable ? `${backupData.pomodoroTable.length}个时段` : '无时段数据',
                    status: backupData && backupData.pomodoroTable ? 'success' : 'warning'
                },
                {
                    name: '总结数据',
                    value: backupData && backupData.completedTasks ? '有总结数据' : '无总结数据',
                    status: backupData && backupData.completedTasks ? 'success' : 'warning'
                },
                {
                    name: '统计信息',
                    value: backupData && backupData.completedCount ? '有统计信息' : '无统计信息',
                    status: backupData && backupData.completedCount ? 'success' : 'warning'
                },
                {
                    name: '数据完整性',
                    value: backupData ? '数据完整' : '无数据',
                    status: backupData ? 'success' : 'error'
                }
            ];
            
            checks.forEach(check => {
                const item = document.createElement('div');
                item.className = `test-item ${check.status}`;
                item.innerHTML = `
                    <h4>${check.name}</h4>
                    <div>${check.value}</div>
                    <span class="status ${check.status}">${getStatusText(check.status)}</span>
                `;
                grid.appendChild(item);
            });
        }
        
        function getStatusText(status) {
            switch(status) {
                case 'success': return '✓ 正常';
                case 'warning': return '⚠ 警告';
                case 'error': return '✗ 错误';
                default: return '? 未知';
            }
        }
        
        // 测试备份创建
        function testBackupCreation() {
            const result = document.getElementById('backupResult');
            let output = '备份创建测试结果：\n\n';
            
            try {
                // 创建测试备份数据
                const testBackupData = {
                    currentDate: '2024年1月1日 星期一',
                    startTime: '09:00',
                    taskCount: '3',
                    tasks: [
                        { number: 1, text: '测试任务1', completed: true },
                        { number: 2, text: '测试任务2', completed: false }
                    ],
                    pomodoroTable: [
                        {
                            timeRange: '09:00-09:25',
                            taskContent: '测试任务1',
                            status: 'completed',
                            completion: '100',
                            notes: '测试备注'
                        }
                    ],
                    completedTasks: '完成了测试任务1',
                    incompleteTasks: '测试任务2未完成',
                    dailyGains: '学会了测试方法',
                    improvements: '明天要更专注',
                    completedCount: '1',
                    totalCount: '2',
                    avgCompletion: '50%',
                    backupAt: new Date().toISOString(),
                    version: '1.0'
                };
                
                // 测试JSON序列化
                const jsonString = JSON.stringify(testBackupData, null, 2);
                output += '✅ JSON序列化：成功\n';
                output += `✅ 数据大小：${jsonString.length} 字符\n`;
                
                // 测试JSON反序列化
                const parsedData = JSON.parse(jsonString);
                output += '✅ JSON反序列化：成功\n';
                
                // 验证必要字段
                const requiredFields = ['version', 'backupAt', 'currentDate', 'tasks'];
                let allFieldsPresent = true;
                requiredFields.forEach(field => {
                    if (!parsedData[field]) {
                        allFieldsPresent = false;
                        output += `❌ 缺少必要字段：${field}\n`;
                    }
                });
                
                if (allFieldsPresent) {
                    output += '✅ 必要字段验证：通过\n';
                }
                
                // 测试文件下载（模拟）
                output += '✅ 文件下载：模拟成功\n';
                output += `✅ 文件名：番茄工作备份_${new Date().toISOString().slice(0, 10)}.json\n`;
                
            } catch (error) {
                output += '❌ 备份创建测试失败：' + error.message + '\n';
            }
            
            result.textContent = output;
        }
        
        // 测试备份验证
        function testBackupValidation() {
            const result = document.getElementById('backupResult');
            let output = '备份验证测试结果：\n\n';
            
            try {
                // 测试有效备份
                const validBackup = {
                    version: '1.0',
                    backupAt: new Date().toISOString(),
                    currentDate: '2024年1月1日',
                    tasks: []
                };
                
                if (validBackup.version && validBackup.backupAt) {
                    output += '✅ 有效备份验证：通过\n';
                } else {
                    output += '❌ 有效备份验证：失败\n';
                }
                
                // 测试无效备份
                const invalidBackup1 = { currentDate: '2024年1月1日' }; // 缺少version
                const invalidBackup2 = { version: '1.0' }; // 缺少backupAt
                const invalidBackup3 = {}; // 空对象
                
                const testCases = [
                    { name: '缺少version字段', data: invalidBackup1 },
                    { name: '缺少backupAt字段', data: invalidBackup2 },
                    { name: '空对象', data: invalidBackup3 }
                ];
                
                testCases.forEach(testCase => {
                    try {
                        if (!testCase.data.version || !testCase.data.backupAt) {
                            output += `✅ ${testCase.name}：正确拒绝\n`;
                        } else {
                            output += `❌ ${testCase.name}：应该拒绝但通过了\n`;
                        }
                    } catch (error) {
                        output += `✅ ${testCase.name}：正确拒绝（${error.message}）\n`;
                    }
                });
                
                // 测试版本兼容性
                const oldVersionBackup = {
                    version: '0.9',
                    backupAt: new Date().toISOString()
                };
                
                if (oldVersionBackup.version !== '1.0') {
                    output += '⚠ 旧版本备份：可能需要兼容性处理\n';
                } else {
                    output += '✅ 版本兼容性：通过\n';
                }
                
            } catch (error) {
                output += '❌ 备份验证测试失败：' + error.message + '\n';
            }
            
            result.textContent = output;
        }
        
        // 测试备份恢复
        function testBackupRestore() {
            const result = document.getElementById('backupResult');
            let output = '备份恢复测试结果：\n\n';
            
            try {
                // 创建测试备份数据
                const testBackup = {
                    version: '1.0',
                    backupAt: new Date().toISOString(),
                    currentDate: '2024年1月1日 星期一',
                    startTime: '09:00',
                    taskCount: '2',
                    tasks: [
                        { number: 1, text: '恢复测试任务1', completed: true },
                        { number: 2, text: '恢复测试任务2', completed: false }
                    ],
                    pomodoroTable: [
                        {
                            timeRange: '09:00-09:25',
                            taskContent: '恢复测试任务1',
                            status: 'completed',
                            completion: '100',
                            notes: '恢复测试备注'
                        }
                    ],
                    completedTasks: '恢复了测试任务1',
                    incompleteTasks: '恢复测试任务2未完成',
                    dailyGains: '学会了恢复方法',
                    improvements: '明天要更专注',
                    completedCount: '1',
                    totalCount: '2',
                    avgCompletion: '50%'
                };
                
                // 模拟恢复过程
                output += '✅ 备份数据解析：成功\n';
                output += '✅ 基本信息恢复：成功\n';
                output += '✅ 任务数据恢复：成功\n';
                output += '✅ 番茄时段恢复：成功\n';
                output += '✅ 总结数据恢复：成功\n';
                output += '✅ 统计信息恢复：成功\n';
                output += '✅ 本地存储更新：成功\n';
                
                // 验证恢复结果
                const restoredData = {
                    currentDate: testBackup.currentDate,
                    startTime: testBackup.startTime,
                    taskCount: testBackup.taskCount,
                    tasks: testBackup.tasks,
                    pomodoroTable: testBackup.pomodoroTable,
                    completedTasks: testBackup.completedTasks,
                    incompleteTasks: testBackup.incompleteTasks,
                    dailyGains: testBackup.dailyGains,
                    improvements: testBackup.improvements,
                    completedCount: testBackup.completedCount,
                    totalCount: testBackup.totalCount,
                    avgCompletion: testBackup.avgCompletion
                };
                
                // 检查恢复的数据完整性
                const dataIntegrity = 
                    restoredData.currentDate === testBackup.currentDate &&
                    restoredData.startTime === testBackup.startTime &&
                    restoredData.tasks.length === testBackup.tasks.length &&
                    restoredData.pomodoroTable.length === testBackup.pomodoroTable.length;
                
                if (dataIntegrity) {
                    output += '✅ 数据完整性验证：通过\n';
                } else {
                    output += '❌ 数据完整性验证：失败\n';
                }
                
                output += '✅ 恢复测试完成\n';
                
            } catch (error) {
                output += '❌ 备份恢复测试失败：' + error.message + '\n';
            }
            
            result.textContent = output;
        }
        
        // 页面加载时初始化
        window.onload = function() {
            updateBackupGrid();
        };
    </script>
</body>
</html> 